# PWM

Pulse Width Modulation (PWM) is a very import feature found in most microcontrollers. PWM is a pulse that is repeated and generated by the internal hardware. The ratio of the pulse width and its frequency is called duty cycle. Through software, you can control the pulse's frequency and duty cycle.

> [!Tip]
> We usually use GetDefault() for most peripherals. For example, there is only one GPIO controller on most systems. This is not the case with PWM. Never use the Default controller and  always select the proper channel on the corresponding controller.

> [!Tip]
> PWM2.3 is channel 3 on controller 2

## Energy Level
PWM is perfect for dimming an LED or slowing down a motor. This is done by turning power on and off, at a high speed. When power is on half the time and off half the time, only half the energy is transferred, to the LED or a motor.

This demo will fade the LED in and out

```csharp
using System;
using System.Diagnostics;
using System.Threading;
using GHIElectronics.TinyCLR.Devices.Pwm;
using GHIElectronics.TinyCLR.Pins;

class Program
{
    static void Main()
    {
        PwmController Controller4 = PwmController.FromId(FEZ.PwmPin.Controller4.Id);
        PwmPin led = Controller4.OpenPin(FEZ.PwmPin.Controller4.Led1);
        Controller4.SetDesiredFrequency(10000);
        double duty = 0.5, speed = 0.01;
        led.Start();
        while (true)
        {
            if (duty <= 0 || duty >= 1.0)
            {
                speed *= -1; //invert dirrection
                duty += speed;
            }

            led.SetActiveDutyCyclePercentage(duty);
            duty += speed;
            
            Thread.Sleep(10); // always give the system time to think!
        }
    }

}   
```

## Musical Tones
Music notes have specific frequencies; C for example is about 261Hz. Plugging these numbers into an array and knowing the length of each tone is all that is needed to play some simple music. When playing notes by changing the frequency, keep thee duty cycle set to 0.5.

```csharp
using System;
using System.Diagnostics;
using System.Threading;
using GHIElectronics.TinyCLR.Devices.Pwm;
using GHIElectronics.TinyCLR.Pins;

class Program
{
    const int NOTE_C = 261;
    const int NOTE_D = 294;
    const int NOTE_E = 330;
    const int NOTE_F = 349;
    const int NOTE_G = 392;

    const int WHOLE_DURATION = 1000;
    const int EIGHTH = WHOLE_DURATION / 8;
    const int QUARTER = WHOLE_DURATION / 4;
    const int QUARTERDOT = WHOLE_DURATION / 3;
    const int HALF = WHOLE_DURATION / 2;
    const int WHOLE = WHOLE_DURATION;

    //make sure the two below arrays match in length. each duration element corresponds to
    //one note element.
    static int[] note = { NOTE_E, NOTE_E, NOTE_F, NOTE_G, NOTE_G, NOTE_F, NOTE_E,
                          NOTE_D, NOTE_C, NOTE_C, NOTE_D, NOTE_E, NOTE_E, NOTE_D,
                          NOTE_D, NOTE_E, NOTE_E, NOTE_F, NOTE_G, NOTE_G, NOTE_F,
                          NOTE_E, NOTE_D, NOTE_C, NOTE_C, NOTE_D, NOTE_E, NOTE_D,
                          NOTE_C, NOTE_C};

    static int[] duration = { QUARTER, QUARTER, QUARTER, QUARTER, QUARTER, QUARTER,    QUARTER,
                              QUARTER, QUARTER, QUARTER, QUARTER, QUARTER, QUARTERDOT, EIGHTH,
                              HALF,    QUARTER, QUARTER, QUARTER, QUARTER, QUARTER,    QUARTER,
                              QUARTER, QUARTER, QUARTER, QUARTER, QUARTER, QUARTER,    QUARTERDOT,
                              EIGHTH,  WHOLE};
    static void Main()
    {
        PwmController Controller1 = PwmController.FromId(FEZ.PwmPin.Controller1.Id);
        PwmPin tones = Controller1.OpenPin(FEZ.PwmPin.Controller1.D0);
        tones.SetActiveDutyCyclePercentage(0.5);
        tones.Start();
        while (true)
        {
            for (int i = 0; i < note.Length; i++)
            {
                Controller1.SetDesiredFrequency( note[i]);
                Thread.Sleep(duration[i]);
            }
            Thread.Sleep(100);
        }
    }

}   
```

## Servo Motors
Servo motors are controlled by a repeated pulse. The pulse is generated every 20ms. This pulse will have a width between 1ms and 2ms, for min and max. Positional servos will go to a specific direction based on the pulse width. Full rotational servos can be controlled, speed and direction, through this pulse, where 1.5ms pulse will stop, 1ms is full speed and 1ms is reverse full speed. 

> [!Tip]
> most servos will have a 1.25ms min and 1.75max.

```csharp
using System;
using System.Diagnostics;
using System.Threading;
using GHIElectronics.TinyCLR.Devices.Pwm;
using GHIElectronics.TinyCLR.Pins;

class Program
{
    static void Main()
    {
        PwmController Controller1 = PwmController.FromId(FEZ.PwmPin.Controller1.Id);
        PwmPin servo = Controller1.OpenPin(FEZ.PwmPin.Controller1.D0);

        Controller1.SetDesiredFrequency(1 / 0.020);//a pulse every 20ms
        double maxPulseLength = 1.75;
        double minPulseLength = 1.25;
        double position = 90;
        double speed = 0.5;
        servo.Start();
        while (true)
        {
            double duty = ((position / 180.0) * (maxPulseLength / 20 - minPulseLength / 20)) + minPulseLength / 20;
            servo.SetActiveDutyCyclePercentage(duty);
            position += speed;
            if (position <= 0 || position >= 180)
                duty *= -1;//reverse dirrection

            Thread.Sleep(10);// always give the system time to think!
        }
    }

}   
```
